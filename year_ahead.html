<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Year Ahead Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 10px;
        }

        .header {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 36px;
            margin: 0;
            color: #333;
            font-family: 'Georgia', 'Times New Roman', serif;
            font-weight: 400;
            letter-spacing: -0.5px;
        }

        .tagline {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
            font-style: italic;
            font-weight: 300;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #4CAF50;
            margin-left: 10px;
        }

        .save-indicator.saving {
            color: #FF9800;
        }

        .save-indicator .icon {
            width: 12px;
            height: 12px;
        }

        .data-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }

        .data-btn {
            padding: 8px 16px;
            font-size: 12px;
        }

        .export-btn {
            background: #2196F3;
            color: white;
        }

        .export-btn:hover {
            background: #1976D2;
        }

        .import-btn {
            background: #9C27B0;
            color: white;
        }

        .import-btn:hover {
            background: #7B1FA2;
        }

        #importFile {
            display: none;
        }

        .view-btn {
            background: #4CAF50;
            color: white;
        }

        .view-btn:hover {
            background: #45a049;
        }

        .view-btn.active {
            background: #2e7d32;
        }


        .category-key {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-panels {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .instructions-panel {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .instructions-panel h3 {
            font-size: 16px;
            margin: 0 0 10px 0;
            color: #333;
        }

        .instructions-panel ul {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            line-height: 1.3;
            color: #555;
        }

        .instructions-panel li {
            margin-bottom: 4px;
        }

        .instructions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .instructions-header h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }

        .instructions-toggle {
            font-size: 18px;
            color: #666;
            transition: transform 0.2s;
        }

        .instructions-panel.collapsed .instructions-toggle {
            transform: rotate(-90deg);
        }

        .instructions-content {
            margin-top: 10px;
            max-height: 1000px;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
            overflow: hidden;
        }

        .instructions-panel.collapsed .instructions-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .instructions-panel strong {
            color: #333;
        }

        .notepad {
            flex: 0 0 48%;
            background: #fffef0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #f0e68c;
        }

        @media (max-width: 768px) {
            .info-panels {
                flex-direction: column;
            }
            
            .notepad {
                flex: 1;
            }
        }

        .notepad-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .notepad-header h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }

        .notepad-toggle {
            font-size: 18px;
            color: #666;
            transition: transform 0.2s;
        }

        .notepad.collapsed .notepad-toggle {
            transform: rotate(-90deg);
        }

        .notepad-content {
            margin-top: 10px;
            max-height: 1000px;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease;
            overflow: hidden;
        }

        .notepad.collapsed .notepad-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .notepad textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            line-height: 1.5;
        }

        .notepad textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }

        .category-key h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .category-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-item input[type="text"] {
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            width: 120px;
        }

        .category-item input[type="color"] {
            width: 40px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px;
        }

        .year-view {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            max-width: 100%;
        }

        .month-view {
            display: flex;
            justify-content: center;
        }

        .month-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
        }

        .month-header {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 2px;
            width: 100%;
            overflow: hidden;
        }

        .day-label {
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            padding: 8px 4px;
            color: #666;
            background: #f9f9f9;
        }

        .day {
            min-height: 70px;
            height: auto;
            border: 1px solid #e0e0e0;
            padding: 4px 0;
            background: white;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
        }

        .day-events {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .day:hover {
            background: #f9f9f9;
        }

        .day.empty {
            background: #fafafa;
            cursor: default;
        }

        .day-number {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
            padding-left: 4px;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            pointer-events: none;
        }

        .event {
            font-size: 10px;
            padding: 0;
            margin-bottom: 0;
            border-radius: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: move;
            color: #333;
            flex-shrink: 0;
            user-select: none;
        }

        .event.dragging {
            opacity: 0.5;
        }

        .day.drag-over {
            background: #e3f2fd;
        }

        .day.drag-creating {
            background: #e8f5e9;
            border-color: #4CAF50;
        }

        .day.drag-creating .drag-preview-event {
            display: block;
            background: rgba(76, 175, 80, 0.3);
            border: 1px dashed #4CAF50;
            font-size: 10px;
            padding: 2px 4px;
            margin-bottom: 2px;
            color: #2e7d32;
            font-weight: 500;
        }

        .drag-preview-event {
            display: none;
            user-select: none;
            -webkit-user-select: none;
            pointer-events: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .event-list {
            margin-bottom: 20px;
        }

        .event-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .event-item-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .event-item input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .event-item input[type="date"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .event-item .color-picker-mini {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .event-item .color-btn-mini {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .event-item .color-btn-mini:hover {
            transform: scale(1.1);
        }

        .event-item .color-btn-mini.selected {
            border: 3px solid #333;
            transform: scale(1.15);
        }

        .event-item button {
            padding: 8px 12px;
            background: #f44336;
            color: white;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .event-date-range {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 12px;
            color: #666;
        }

        .add-event-btn {
            background: #2196F3;
            color: white;
            width: 100%;
            margin-bottom: 15px;
        }

        .close-btn {
            background: #666;
            color: white;
            width: 100%;
        }

        @media (max-width: 1200px) {
            .year-view {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .year-view {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .year-view {
                grid-template-columns: 1fr;
            }
            
            .calendar {
                gap: 1px;
            }
            
            .day {
                min-height: 60px;
            }
            
            .event {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>Year Ahead <span id="currentYearDisplay"></span></h1>
            <div class="tagline">A simple visual planner for your year ahead</div>
            <span class="save-indicator" id="saveIndicator">
                <span class="icon">✓</span>
                <span>Saved</span>
            </span>
        </div>
        <div class="controls">
            <select id="yearSelect" style="padding: 10px; border-radius: 6px; border: 1px solid #ddd;" onchange="changeYear()">
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
            </select>
            <button class="view-btn active" onclick="setView('year')">Year View</button>
            <button class="view-btn" onclick="setView('month')">Month View</button>
            <select id="monthSelect" style="padding: 10px; border-radius: 6px; border: 1px solid #ddd;" onchange="changeMonth()">
                <option value="0">January</option>
                <option value="1">February</option>
                <option value="2">March</option>
                <option value="3">April</option>
                <option value="4">May</option>
                <option value="5">June</option>
                <option value="6">July</option>
                <option value="7">August</option>
                <option value="8">September</option>
                <option value="9">October</option>
                <option value="10">November</option>
                <option value="11">December</option>
            </select>
            <div class="data-controls">
                <button class="data-btn export-btn" onclick="exportData()">Export Data</button>
                <button class="data-btn import-btn" onclick="document.getElementById('importFile').click()">Import Data</button>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            </div>
        </div>
    </div>

    <div class="category-key">
        <h3>Personal Category Key</h3>
        <div class="category-items" id="categoryItems"></div>
    </div>

    <div class="info-panels">
        <div class="notepad" id="notepad">
            <div class="notepad-header" onclick="toggleNotepad()">
                <h3 id="notepadHeader">Notes</h3>
                <span class="notepad-toggle">▼</span>
            </div>
            <div class="notepad-content">
                <textarea id="notepadText" placeholder="Jot down your thoughts, reminders, or things to do here..."></textarea>
            </div>
        </div>
        <div class="instructions-panel" id="instructionsPanel">
            <div class="instructions-header" onclick="toggleInstructions()">
                <h3>How to Use</h3>
                <span class="instructions-toggle">▼</span>
            </div>
            <div class="instructions-content">
                <ul>
                    <li><strong>Create Events:</strong> Click and drag across days to create multi-day events</li>
                    <li><strong>Move Events:</strong> Click and drag an existing event to move it to a new date</li>
                    <li><strong>Edit Events:</strong> Click any day or event to open the editor</li>
                    <li><strong>Customize Colors:</strong> Use the color pickers in Category Key to customize event colors</li>
                    <li><strong>Multi-Day Events:</strong> Events can span multiple days - set start and end dates in the editor</li>
                    <li><strong>Auto-Save:</strong> All changes save automatically to your browser's local storage</li>
                    <li><strong>Export Data:</strong> Click "Export Data" to download a backup file with ALL years' data (saves to your computer)</li>
                    <li><strong>Import Data:</strong> Click "Import Data" to restore from a backup file</li>
                    <li><strong>Important:</strong> Data is stored locally in your browser. Clear browser data = lose your calendar. Always export backups!</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="yearView" class="year-view"></div>
    <div id="monthView" class="month-view" style="display: none;"></div>

    <div id="modal" class="modal" onclick="handleModalClick(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header" id="modalHeader"></div>
            <div class="event-list" id="eventList"></div>
            <button class="add-event-btn" onclick="addEvent()">+ Add Event</button>
            <button class="close-btn" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        let colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];
        let selectedColor = '#FF6B6B';
        let currentView = 'year';
        let currentMonth = 0;
        let selectedDate = null;
        let currentYear = 2026;
        let events = []; // Changed to array for multi-day events
        let categories = {};
        
        // Drag state
        let dragState = {
            isDragging: false,
            dragType: null, // 'create' or 'move'
            startDate: null,
            endDate: null,
            draggedEvent: null,
            draggedEventIdx: null,
            justFinishedDrag: false,
            mouseDownX: 0,
            mouseDownY: 0,
            dragThreshold: 5 // pixels to move before drag starts
        };

        // Initialize categories for each color
        colors.forEach(color => {
            categories[color] = '';
        });

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'year') {
                document.getElementById('yearView').style.display = 'grid';
                document.getElementById('monthView').style.display = 'none';
                document.getElementById('monthSelect').style.display = 'none';
            } else {
                document.getElementById('yearView').style.display = 'none';
                document.getElementById('monthView').style.display = 'flex';
                document.getElementById('monthSelect').style.display = 'block';
                renderMonth(currentMonth);
            }
        }

        function changeMonth() {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            renderMonth(currentMonth);
        }

        function changeYear() {
            // Save current year's data before switching
            saveData();
            
            // Switch to new year
            currentYear = parseInt(document.getElementById('yearSelect').value);
            
            // Update year display
            updateYearDisplay();
            
            // Load new year's data
            loadData();
            
            // Refresh view
            refreshView();
            renderCategoryKey();
        }

        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(month, year) {
            return new Date(year, month, 1).getDay();
        }

        function renderCalendar(month, year, container) {
            // Use currentYear if year not specified
            if (!year) year = currentYear;
            const daysInMonth = getDaysInMonth(month, year);
            const firstDay = getFirstDayOfMonth(month, year);
            
            let html = '<div class="month-container">';
            html += `<div class="month-header">${monthNames[month]} ${year}</div>`;
            html += '<div class="calendar">';
            
            // Day labels
            dayNames.forEach(day => {
                html += `<div class="day-label">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="day empty"></div>';
            }
            
            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = getEventsForDate(dateKey);
                
                html += `<div class="day" data-date="${dateKey}" onmousedown="handleDayMouseDown(event, '${dateKey}')" onmouseenter="handleDayMouseEnter(event, '${dateKey}')" onclick="handleDayClick(event, '${dateKey}')">`;
                html += `<div class="day-number">${day}</div>`;
                html += `<div class="day-events">`;
                
                dayEvents.forEach((evt, evtIdx) => {
                    const eventIdx = events.indexOf(evt);
                    html += `<div class="event" data-event-idx="${eventIdx}" style="background: ${evt.color};" onmousedown="handleEventMouseDown(event, ${eventIdx})" onclick="handleEventClick(event, ${eventIdx}, '${dateKey}')">${evt.text}</div>`;
                });
                
                html += `</div></div>`;
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        function renderYear() {
            const yearView = document.getElementById('yearView');
            yearView.innerHTML = '';
            
            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                renderCalendar(month, currentYear, monthDiv);
                yearView.appendChild(monthDiv);
            }
        }

        function renderMonth(month) {
            const monthView = document.getElementById('monthView');
            renderCalendar(month, currentYear, monthView);
        }

        function openModal(dateKey) {
            selectedDate = dateKey;
            const modal = document.getElementById('modal');
            const date = new Date(dateKey + 'T00:00:00');
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            document.getElementById('modalHeader').textContent = dateStr;
            renderEventList();
            modal.classList.add('active');
        }

        function getEventsForDate(dateKey) {
            const date = new Date(dateKey + 'T00:00:00');
            return events.filter(evt => {
                const startDate = new Date(evt.startDate + 'T00:00:00');
                const endDate = new Date(evt.endDate + 'T00:00:00');
                return date >= startDate && date <= endDate;
            });
        }

        function dateToString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function handleDayMouseDown(e, dateKey) {
            // Only start drag if clicking on empty day area (not on an event)
            if (!e.target.classList.contains('event')) {
                e.preventDefault(); // Prevent text selection
                dragState.mouseDownX = e.clientX;
                dragState.mouseDownY = e.clientY;
                dragState.startDate = dateKey;
                dragState.endDate = dateKey;
            }
        }

        function handleDayMouseEnter(e, dateKey) {
            if (dragState.isDragging) {
                if (dragState.dragType === 'create') {
                    dragState.endDate = dateKey;
                    updateDragCreatePreview();
                } else if (dragState.dragType === 'move') {
                    dragState.endDate = dateKey;
                    const dayEl = e.currentTarget;
                    if (dayEl) {
                        dayEl.classList.add('drag-over');
                    }
                }
            }
        }

        function updateDragCreatePreview() {
            // Clear previous preview
            document.querySelectorAll('.day.drag-creating').forEach(day => {
                day.classList.remove('drag-creating');
                const preview = day.querySelector('.drag-preview-event');
                if (preview) preview.remove();
            });

            if (!dragState.startDate || !dragState.endDate) return;

            const startDate = new Date(dragState.startDate + 'T00:00:00');
            const endDate = new Date(dragState.endDate + 'T00:00:00');
            
            // Ensure start is before end
            let actualStart = startDate < endDate ? startDate : endDate;
            let actualEnd = startDate < endDate ? endDate : startDate;

            // Highlight all days in the range
            const currentDate = new Date(actualStart);
            while (currentDate <= actualEnd) {
                const dateKey = dateToString(currentDate);
                const dayEl = document.querySelector(`.day[data-date="${dateKey}"]`);
                if (dayEl && !dayEl.classList.contains('empty')) {
                    dayEl.classList.add('drag-creating');
                    
                    // Add preview event if it's the first day or if there's no event in this day yet
                    const dayEvents = dayEl.querySelector('.day-events');
                    if (dayEvents && !dayEvents.querySelector('.drag-preview-event')) {
                        const preview = document.createElement('div');
                        preview.className = 'drag-preview-event';
                        preview.textContent = 'New Event';
                        dayEvents.insertBefore(preview, dayEvents.firstChild);
                    }
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }

        function handleDayClick(e, dateKey) {
            // Only open modal if we didn't just finish a drag
            if (!dragState.isDragging && !dragState.justFinishedDrag) {
                openModal(dateKey);
            }
        }

        function handleEventMouseDown(e, eventIdx) {
            e.preventDefault(); // Prevent text selection
            dragState.mouseDownX = e.clientX;
            dragState.mouseDownY = e.clientY;
            dragState.draggedEvent = events[eventIdx];
            dragState.draggedEventIdx = eventIdx;
            e.stopPropagation();
        }

        function handleEventClick(e, eventIdx, dateKey) {
            // Open modal for the day containing this event
            // Only if we didn't actually drag
            if (!dragState.isDragging && !dragState.justFinishedDrag) {
                e.stopPropagation();
                openModal(dateKey);
            }
        }

        function updateDragPreview() {
            // Visual feedback could be added here
        }

        function finishDrag() {
            if (!dragState.isDragging) {
                // Clean up any leftover drag classes even if not dragging
                document.querySelectorAll('.day.drag-over').forEach(el => el.classList.remove('drag-over'));
                document.querySelectorAll('.day.drag-creating').forEach(el => {
                    el.classList.remove('drag-creating');
                    const preview = el.querySelector('.drag-preview-event');
                    if (preview) preview.remove();
                });
                return;
            }
            
            let eventCreated = false;
            
            if (dragState.dragType === 'create' && dragState.startDate && dragState.endDate) {
                // Create new event
                const startDate = new Date(dragState.startDate + 'T00:00:00');
                const endDate = new Date(dragState.endDate + 'T00:00:00');
                
                // Ensure start is before end
                let actualStart = dragState.startDate;
                let actualEnd = dragState.endDate;
                if (startDate > endDate) {
                    actualStart = dragState.endDate;
                    actualEnd = dragState.startDate;
                }
                
                const newEvent = {
                    text: 'New Event',
                    color: selectedColor,
                    startDate: actualStart,
                    endDate: actualEnd
                };
                events.push(newEvent);
                eventCreated = true;
            } else if (dragState.dragType === 'move' && dragState.draggedEvent && dragState.endDate) {
                // Move existing event
                const event = dragState.draggedEvent;
                const oldStartDate = new Date(event.startDate + 'T00:00:00');
                const oldEndDate = new Date(event.endDate + 'T00:00:00');
                const newStartDate = new Date(dragState.endDate + 'T00:00:00');
                
                // Calculate duration
                const duration = Math.floor((oldEndDate - oldStartDate) / (1000 * 60 * 60 * 24));
                
                // Update event dates
                event.startDate = dragState.endDate;
                const newEndDate = new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate() + duration);
                event.endDate = dateToString(newEndDate);
                eventCreated = true;
            }
            
            if (eventCreated) {
                saveData();
                refreshView();
            }
            
            // Reset drag state
            dragState.isDragging = false;
            dragState.dragType = null;
            dragState.startDate = null;
            dragState.endDate = null;
            dragState.draggedEvent = null;
            dragState.draggedEventIdx = null;
            dragState.justFinishedDrag = true;
            
            // Remove drag classes
            document.querySelectorAll('.day.drag-over').forEach(el => el.classList.remove('drag-over'));
            document.querySelectorAll('.day.drag-creating').forEach(el => {
                el.classList.remove('drag-creating');
                const preview = el.querySelector('.drag-preview-event');
                if (preview) preview.remove();
            });
            document.querySelectorAll('.event.dragging').forEach(el => el.classList.remove('dragging'));
            
            // Reset flag after a short delay to allow click events
            setTimeout(() => {
                dragState.justFinishedDrag = false;
            }, 100);
        }

        // Add global mouse handlers
        document.addEventListener('mouseup', function(e) {
            if (dragState.isDragging) {
                // Find which day we're over
                const dayEl = e.target.closest('.day');
                if (dayEl && dayEl.dataset.date) {
                    dragState.endDate = dayEl.dataset.date;
                } else {
                    // If we're not over a day, try to find the day from the element
                    const dayFromElement = e.target.closest('.day[data-date]');
                    if (dayFromElement) {
                        dragState.endDate = dayFromElement.dataset.date;
                    }
                }
                finishDrag();
            } else {
                // Reset drag state if we didn't drag (just clicked)
                if (dragState.startDate || dragState.draggedEvent) {
                    dragState.startDate = null;
                    dragState.endDate = null;
                    dragState.draggedEvent = null;
                    dragState.draggedEventIdx = null;
                }
            }
        });

        document.addEventListener('mousemove', function(e) {
            // Check if we should start dragging (mouse moved beyond threshold)
            if (!dragState.isDragging && (dragState.draggedEvent || dragState.startDate)) {
                const dx = Math.abs(e.clientX - dragState.mouseDownX);
                const dy = Math.abs(e.clientY - dragState.mouseDownY);
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > dragState.dragThreshold) {
                    // Start dragging
                    dragState.isDragging = true;
                    if (dragState.draggedEvent) {
                        dragState.dragType = 'move';
                        const eventEl = document.querySelector(`[data-event-idx="${dragState.draggedEventIdx}"]`);
                        if (eventEl) eventEl.classList.add('dragging');
                    } else if (dragState.startDate) {
                        dragState.dragType = 'create';
                        updateDragCreatePreview();
                    }
                }
            }
            
            // Handle drag updates
            if (dragState.isDragging) {
                if (dragState.dragType === 'create') {
                    const dayEl = e.target.closest('.day');
                    if (dayEl && dayEl.dataset.date) {
                        dragState.endDate = dayEl.dataset.date;
                        updateDragCreatePreview();
                    }
                } else if (dragState.dragType === 'move') {
                    const dayEl = e.target.closest('.day');
                    if (dayEl) {
                        document.querySelectorAll('.day.drag-over').forEach(el => {
                            if (el !== dayEl) el.classList.remove('drag-over');
                        });
                        dayEl.classList.add('drag-over');
                        dragState.endDate = dayEl.dataset.date;
                    }
                }
            }
        });

        function closeModal() {
            // Save data before closing
            saveData();
            document.getElementById('modal').classList.remove('active');
        }

        function handleModalClick(e) {
            // If clicking on the modal backdrop (not the content), close the modal
            if (e.target.id === 'modal') {
                closeModal();
            }
        }

        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('modal');
                if (modal.classList.contains('active')) {
                    closeModal();
                }
            }
        });

        function renderEventList() {
            const eventList = document.getElementById('eventList');
            const dayEvents = getEventsForDate(selectedDate);
            
            let html = '';
            dayEvents.forEach((evt, idx) => {
                const eventIdx = events.indexOf(evt);
                html += `<div class="event-item">`;
                html += `<div class="event-item-row">`;
                html += `<input type="text" value="${evt.text}" placeholder="Event name" onchange="updateEventText(${eventIdx}, this.value)">`;
                html += `<button onclick="deleteEvent(${eventIdx})">Delete</button>`;
                html += `</div>`;
                html += `<div class="event-item-row">`;
                html += `<div class="color-picker-mini">`;
                colors.forEach(color => {
                    const selected = evt.color === color ? 'selected' : '';
                    html += `<div class="color-btn-mini ${selected}" style="background: ${color};" data-color="${color}" onclick="updateEventColor(${eventIdx}, '${color}')"></div>`;
                });
                html += `</div>`;
                html += `</div>`;
                html += `<div class="event-date-range">`;
                html += `<label>Start: <input type="date" value="${evt.startDate}" onchange="updateEventStartDate(${eventIdx}, this.value)"></label>`;
                html += `<label>End: <input type="date" value="${evt.endDate}" onchange="updateEventEndDate(${eventIdx}, this.value)"></label>`;
                html += `</div>`;
                html += `</div>`;
            });
            
            eventList.innerHTML = html;
        }

        function addEvent() {
            const newEvent = {
                text: 'New Event',
                color: selectedColor,
                startDate: selectedDate,
                endDate: selectedDate
            };
            events.push(newEvent);
            renderEventList();
            saveData();
            refreshView();
        }

        function updateEventText(idx, text) {
            if (events[idx]) {
                events[idx].text = text;
                saveData();
                refreshView();
            }
        }

        function updateEventColor(idx, color) {
            if (events[idx]) {
                events[idx].color = color;
                renderEventList(); // Refresh to show selected color
                saveData();
                refreshView();
            }
        }

        function updateEventStartDate(idx, startDate) {
            if (events[idx]) {
                events[idx].startDate = startDate;
                // Ensure end date is not before start date
                if (new Date(events[idx].endDate) < new Date(startDate)) {
                    events[idx].endDate = startDate;
                }
                saveData();
                refreshView();
            }
        }

        function updateEventEndDate(idx, endDate) {
            if (events[idx]) {
                // Ensure end date is not before start date
                if (new Date(endDate) < new Date(events[idx].startDate)) {
                    events[idx].endDate = events[idx].startDate;
                } else {
                    events[idx].endDate = endDate;
                }
                saveData();
                refreshView();
            }
        }

        function deleteEvent(idx) {
            events.splice(idx, 1);
            renderEventList();
            saveData();
            refreshView();
        }

        function refreshView() {
            if (currentView === 'year') {
                renderYear();
            } else {
                renderMonth(currentMonth);
            }
        }

        function renderCategoryKey() {
            const container = document.getElementById('categoryItems');
            let html = '';
            
            colors.forEach((color, idx) => {
                html += `<div class="category-item">`;
                html += `<input type="color" value="${color}" onchange="updateCategoryColor(${idx}, this.value)">`;
                html += `<input type="text" placeholder="Category name" value="${categories[color] || ''}" 
                         onchange="updateCategory('${color}', this.value)">`;
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        function updateCategory(color, name) {
            categories[color] = name;
            saveData();
        }

        function updateCategoryColor(idx, newColor) {
            const oldColor = colors[idx];
            colors[idx] = newColor;
            
            // Update category mapping
            if (categories[oldColor] !== undefined) {
                categories[newColor] = categories[oldColor];
                delete categories[oldColor];
            } else {
                categories[newColor] = '';
            }
            
            // Update all events using the old color
            events.forEach(evt => {
                if (evt.color === oldColor) {
                    evt.color = newColor;
                }
            });
            
            // Update selected color if it was the one changed
            if (selectedColor === oldColor) {
                selectedColor = newColor;
            }
            
            // Refresh UI
            renderCategoryKey();
            // Re-render event list if modal is open
            if (selectedDate) {
                renderEventList();
            }
            refreshView();
            saveData();
        }


        function toggleNotepad() {
            const notepad = document.getElementById('notepad');
            notepad.classList.toggle('collapsed');
            const isCollapsed = notepad.classList.contains('collapsed');
            saveNotepadState(isCollapsed);
        }

        function toggleInstructions() {
            const instructions = document.getElementById('instructionsPanel');
            instructions.classList.toggle('collapsed');
        }

        function updateYearDisplay() {
            document.getElementById('currentYearDisplay').textContent = currentYear;
            document.getElementById('notepadHeader').textContent = `Notes ${currentYear}`;
        }

        function saveNotepadState(isCollapsed) {
            const saved = localStorage.getItem(`planner${currentYear}`);
            const data = saved ? JSON.parse(saved) : {};
            data.notepadCollapsed = isCollapsed;
            localStorage.setItem(`planner${currentYear}`, JSON.stringify(data));
        }

        function saveData() {
            const notepadText = document.getElementById('notepadText').value;
            const notepad = document.getElementById('notepad');
            const isCollapsed = notepad.classList.contains('collapsed');
            const data = { events, categories, colors, notepadText, notepadCollapsed: isCollapsed };
            localStorage.setItem(`planner${currentYear}`, JSON.stringify(data));
            showSaveIndicator();
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('saving');
            indicator.innerHTML = '<span class="icon">⏳</span><span>Saving...</span>';
            
            setTimeout(() => {
                indicator.classList.remove('saving');
                indicator.innerHTML = '<span class="icon">✓</span><span>Saved</span>';
            }, 500);
        }

        function exportData() {
            // Collect data for all years (2026-2030)
            const allYearsData = {};
            const years = [2026, 2027, 2028, 2029, 2030];
            
            years.forEach(year => {
                const saved = localStorage.getItem(`planner${year}`);
                if (saved) {
                    try {
                        allYearsData[year] = JSON.parse(saved);
                    } catch (e) {
                        console.error(`Error loading data for ${year}:`, e);
                    }
                }
            });
            
            // Include current year's notepad state
            const notepad = document.getElementById('notepad');
            const isCollapsed = notepad.classList.contains('collapsed');
            const currentNotepadText = document.getElementById('notepadText').value;
            
            // If current year data exists, update its notepad
            if (allYearsData[currentYear]) {
                allYearsData[currentYear].notepadText = currentNotepadText;
                allYearsData[currentYear].notepadCollapsed = isCollapsed;
            }
            
            const data = {
                allYears: allYearsData,
                currentYear: currentYear,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `year-ahead-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showSaveIndicator();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('This will replace all your current data for all years. Are you sure you want to continue?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Check if this is the new format (v2.0 with allYears) or old format (v1.0 with single year)
                    if (data.allYears && data.version === '2.0') {
                        // New format: import all years
                        Object.keys(data.allYears).forEach(year => {
                            const yearData = data.allYears[year];
                            localStorage.setItem(`planner${year}`, JSON.stringify(yearData));
                        });
                        
                        // Switch to the current year from backup if available
                        if (data.currentYear) {
                            currentYear = data.currentYear;
                            document.getElementById('yearSelect').value = currentYear;
                        }
                        
                        // Load current year's data
                        loadData();
                    } else if (data.events && data.colors) {
                        // Old format: single year backup
                        const importYear = data.year || currentYear;
                        
                        if (data.year && data.year !== currentYear) {
                            if (confirm(`This backup is for ${data.year}. Switch to ${data.year}?`)) {
                                currentYear = data.year;
                                document.getElementById('yearSelect').value = currentYear;
                            }
                        }
                        
                        // Save to the appropriate year
                        localStorage.setItem(`planner${importYear}`, JSON.stringify(data));
                        
                        // Load current year's data
                        loadData();
                    } else {
                        alert('Invalid file format. Please select a valid backup file.');
                        event.target.value = '';
                        return;
                    }
                    
                    // Update UI
                    updateYearDisplay();
                    renderCategoryKey();
                    refreshView();
                    
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function loadData() {
            const saved = localStorage.getItem(`planner${currentYear}`);
            if (saved) {
                const data = JSON.parse(saved);
                // Handle migration from old format (object) to new format (array)
                if (Array.isArray(data.events)) {
                    // Filter events to only include those for the current year
                    events = data.events.filter(evt => {
                        const eventYear = new Date(evt.startDate + 'T00:00:00').getFullYear();
                        return eventYear === currentYear;
                    });
                } else if (data.events && typeof data.events === 'object') {
                    // Migrate old format to new format
                    events = [];
                    Object.keys(data.events).forEach(dateKey => {
                        const eventYear = new Date(dateKey + 'T00:00:00').getFullYear();
                        if (eventYear === currentYear) {
                            data.events[dateKey].forEach(evt => {
                                events.push({
                                    text: evt.text,
                                    color: evt.color,
                                    startDate: dateKey,
                                    endDate: dateKey
                                });
                            });
                        }
                    });
                } else {
                    events = [];
                }
                categories = data.categories || {};
                
                // Load custom colors if saved
                if (data.colors && Array.isArray(data.colors) && data.colors.length === colors.length) {
                    colors = data.colors;
                }
                
                // Ensure categories exist for all colors
                colors.forEach(color => {
                    if (!categories[color]) categories[color] = '';
                });
                
                // Load notepad text (always set it, even if empty)
                document.getElementById('notepadText').value = data.notepadText || '';
                
                // Load notepad collapsed state
                if (data.notepadCollapsed === true) {
                    document.getElementById('notepad').classList.add('collapsed');
                } else {
                    document.getElementById('notepad').classList.remove('collapsed');
                }
            } else {
                // No saved data for this year - clear everything
                events = [];
                document.getElementById('notepadText').value = '';
                document.getElementById('notepad').classList.remove('collapsed');
            }
        }

        // Initialize
        // Set year selector to current year
        document.getElementById('yearSelect').value = currentYear;
        updateYearDisplay();
        loadData();
        renderYear();
        renderCategoryKey();
        
        // Auto-save notepad on input
        document.getElementById('notepadText').addEventListener('input', function() {
            saveData();
        });
    </script>
</body>
</html>

